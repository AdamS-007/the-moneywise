<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Asset {{ asset.id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lumen/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; }
        .container { padding-top: 40px; padding-bottom: 40px; }
        .card-header { background-color: #007bff; color: white; }
        .form-label { font-weight: 500; color: #343a40; }
        .form-control:focus, .form-select:focus {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.25rem rgba(23, 162, 184, 0.25);
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-primary">✍️ Edit Asset #{{ asset.id }}</h1>
        <p><a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">← Back to Search</a></p>

        <div class="card">
            <div class="card-header">
                Update Asset Details
            </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if message %}
                    <div class="alert alert-success">{{ message }}</div>
                {% endif %}

                <form method="POST">

                    <input type="hidden" name="original_serial_number" value="{{ asset.serial_number if asset.serial_number and not asset.serial_number.startswith('SYNTHETIC_') else '' }}">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="asset_type" class="form-label">Asset Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="asset_type" name="asset_type" required>
                                <option value="">-- Select Asset Type --</option>
                                {% for type in unique_asset_types %}
                                <option value="{{ type.lower() }}"
                                        {% if asset.asset_type and asset.asset_type.lower() == type.lower() %} selected {% endif %}>
                                    {{ type }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="serial_number" class="form-label">Serial Number</label>
                            {% set is_synthetic = asset.serial_number and asset.serial_number.startswith('SYNTHETIC_') %}
                            <input type="text"
                                class="form-control"
                                id="serial_number"
                                name="serial_number"
                                value="{{ asset.serial_number if asset.serial_number else '' }}"
                                {% if is_synthetic %} disabled {% endif %}
                            >
                            <div class="form-text text-warning">
                                {% if is_synthetic %}
                                    (Non-serialized asset ID. Cannot be edited.)
                                {% else %}
                                    This must be unique!
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="product" class="form-label">Product (Model)</label>
                            <input type="text" class="form-control" id="product" name="product" value="{{ asset.product if asset.product else '' }}">
                            <div class="form-text">e.g., MacBook Pro (16-inch), Dell Latitude 7450</div>
                        </div>
                        <div class="col-md-6">
                            <label for="name" class="form-label">Name (Internal Tag/ID)</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ asset.name if asset.name else '' }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="used_by_name" class="form-label">Used by (Name)</label>
                            <input type="text" class="form-control" id="used_by_name" name="used_by_name" value="{{ asset.used_by_name if asset.used_by_name else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="used_by_email" class="form-label">Used by (Email)</label>
                            <input type="email" class="form-control" id="used_by_email" name="used_by_email" value="{{ asset.used_by_email if asset.used_by_email else '' }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" name="department">
                                <option value="">-- Select Department --</option>
                                {% for dept in unique_departments %}
                                <option value="{{ dept.lower() }}"
                                        {% if asset.department and asset.department.lower() == dept.lower() %} selected {% endif %}>
                                    {{ dept }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="location_select" class="form-label">Location</label>
                            {% set current_location_lower = asset.location.lower() if asset.location else '' %}

                            {% set known_locations = unique_locations | map('lower') | list %}
                            {% set is_other_location = current_location_lower and current_location_lower not in known_locations %}

                            <select class="form-select" id="location_select" name="location_select">
                                <option value="">-- Select Location --</option>
                                {% for loc in unique_locations %}
                                <option value="{{ loc.lower() }}"
                                        {% if current_location_lower == loc.lower() %} selected {% endif %}>
                                    {{ loc }}
                                </option>
                                {% endfor %}
                                <option value="other"
                                        {% if is_other_location %} selected {% endif %}>
                                    -- Other (Enter New Location) --
                                </option>
                            </select>

                            {% if is_other_location %}
                                {% set display_style = "block" %}
                                {% set location_value = asset.location %}
                            {% else %}
                                {% set display_style = "none" %}
                                {% set location_value = "" %}
                            {% endif %}

                            <div id="new_location_group" style="display:{{ display_style }}; margin-top: 10px;">
                                <input type="text"
                                    class="form-control"
                                    id="new_location_input"
                                    name="new_location_input"
                                    placeholder="Enter new location name"
                                    value="{{ location_value }}"
                                >
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg mt-4">Save Changes</button>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg mt-4">Cancel</a>
                </form>
            </div>
        </div>
    </div>

    <script>
        // JavaScript to show the hidden input when 'Other' is selected
        document.addEventListener('DOMContentLoaded', function() {
            const locationSelect = document.getElementById('location_select');
            const newLocationGroup = document.getElementById('new_location_group');
            const newLocationInput = document.getElementById('new_location_input');

            // Function to check and update visibility
            function toggleNewLocationInput() {
                // If "Other" is selected, or if the page loaded with an unrecognized location selected (is_other_location=true)
                if (locationSelect.value === 'other') {
                    newLocationGroup.style.display = 'block';
                    newLocationInput.setAttribute('required', 'required'); // Require input if 'Other' is selected
                } else {
                    newLocationGroup.style.display = 'none';
                    newLocationInput.removeAttribute('required');
                }
            }

            // Event listener for changes to the dropdown
            locationSelect.addEventListener('change', toggleNewLocationInput);

            // Check visibility on page load
            toggleNewLocationInput();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
